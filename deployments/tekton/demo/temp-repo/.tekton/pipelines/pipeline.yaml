apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: pytest-pipeline
  namespace: reposentry-demo
spec:
  description: CI/CD Pipeline for Python pytest POC
  params:
    - name: git-url
      type: string
      description: Git repository URL
    - name: git-revision
      type: string
      description: Git revision to checkout
    - name: git-short-sha
      type: string
      description: Short SHA for naming
  workspaces:
    - name: shared-data
      description: Shared workspace for pipeline tasks
  tasks:
    - name: run-pytest-tests
      taskRef:
        name: pytest-task
      params:
        - name: git-url
          value: $(params.git-url)
        - name: git-revision
          value: $(params.git-revision)
      workspaces:
        - name: source
          workspace: shared-data
  finally:
    - name: show-test-reports-link
      params:
        - name: git-revision
          value: $(params.git-revision)
        - name: git-short-sha
          value: $(params.git-short-sha)
      taskSpec:
        params:
          - name: git-revision
          - name: git-short-sha
        steps:
          - name: display-links
            image: alpine:latest
            script: |
              #!/bin/sh
              echo ""
              echo "ğŸ‰ ===== PYTEST EXECUTION COMPLETED ===== ğŸ‰"
              echo ""
              
              # Get short SHA for consistent naming
              SHORT_SHA=$(echo "$(params.git-revision)" | cut -c1-8)
              FULL_SHA="$(params.git-revision)"
              
              echo "ğŸ“Š Test Reports Generated Successfully!"
              echo "ğŸ¯ Git SHA: $SHORT_SHA (from $FULL_SHA)"
              echo ""
              
              echo "ğŸ”— ===== KEY LINKS ===== ğŸ”—"
              echo ""
              echo "ğŸ“Š Test Reports Web UI:"
              echo "   ğŸŒ Main Dashboard: http://results.10.34.2.129.nip.io/"
              echo "   ğŸ¯ This Pipeline: http://results.10.34.2.129.nip.io/pytest-run-$SHORT_SHA/"
              echo "   ğŸ“‹ View HTML reports, coverage analysis, download artifacts"
              echo ""
              echo "ğŸ“ˆ Tekton Dashboard:"
              echo "   ğŸ  Main Dashboard: http://tekton.10.34.2.129.nip.io"
              echo "   ğŸ¯ This PipelineRun: http://tekton.10.34.2.129.nip.io/#/namespaces/tekton-pipelines/pipelineruns/pytest-run-$SHORT_SHA"
              echo ""
              echo "ğŸ“± GitHub Repository:"
              echo "   ğŸ”— https://github.com/johnnynv-org/tekton-complete-poc/commit/$FULL_SHA"
              echo ""
              
              echo "ğŸ“‹ Available Reports:"
              echo "   ğŸ“ˆ Full Test Report (HTML)"
              echo "   ğŸ’¨ Smoke Tests Report" 
              echo "   ğŸ“Š Code Coverage Analysis"
              echo "   ğŸ“ Coverage XML for CI/CD integration"
              echo "   ğŸ“œ Execution logs and summaries"
              echo ""
              
              echo "â±ï¸  Reports available immediately at the Web UI link above"
              echo "âœ… Pipeline completed successfully!"
              echo "=============================================="