# RepoSentry æµ‹è¯•ä¸“ç”¨çš„ Tekton Task
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: reposentry-test-task
  namespace: tekton-pipelines
spec:
  description: "RepoSentry ç«¯åˆ°ç«¯æµ‹è¯•ç”¨ Taskï¼Œå¤„ç†æ¥è‡ª Git ä»“åº“çš„ webhook äº‹ä»¶"
  params:
    - name: repo-name
      description: "ä»“åº“åç§°"
      type: string
      default: "unknown"
    - name: repo-url
      description: "ä»“åº“ URL"
      type: string
      default: ""
    - name: branch
      description: "åˆ†æ”¯åç§°"
      type: string
      default: "main"
    - name: commit-sha
      description: "æäº¤ SHA"
      type: string
      default: ""
    - name: event-type
      description: "äº‹ä»¶ç±»å‹"
      type: string
      default: "push"
    - name: provider
      description: "Git æä¾›å•† (github/gitlab)"
      type: string
      default: "github"
    - name: reposentry-event-id
      description: "RepoSentry äº‹ä»¶ ID"
      type: string
      default: ""
    - name: reposentry-timestamp
      description: "RepoSentry æ—¶é—´æˆ³"
      type: string
      default: ""
  steps:
    - name: validate-webhook-data
      image: cgr.dev/chainguard/bash:latest
      securityContext:
        allowPrivilegeEscalation: false
        runAsNonRoot: true
        capabilities:
          drop:
            - "ALL"
        seccompProfile:
          type: "RuntimeDefault"
      script: |
        #!/bin/bash
        set -e
        
        echo "ğŸš€ ==========================="
        echo "   RepoSentry ç«¯åˆ°ç«¯æµ‹è¯•"
        echo "==========================="
        echo "ğŸ“¦ ä»“åº“ä¿¡æ¯:"
        echo "  åç§°: $(params.repo-name)"
        echo "  URL: $(params.repo-url)"
        echo "  åˆ†æ”¯: $(params.branch)"
        echo "  æäº¤: $(params.commit-sha)"
        echo "  äº‹ä»¶ç±»å‹: $(params.event-type)"
        echo "  æä¾›å•†: $(params.provider)"
        echo ""
        echo "ğŸ” RepoSentry å…ƒæ•°æ®:"
        echo "  äº‹ä»¶ID: $(params.reposentry-event-id)"
        echo "  æ—¶é—´æˆ³: $(params.reposentry-timestamp)"
        echo ""
        echo "â° ç³»ç»Ÿä¿¡æ¯:"
        echo "  æ‰§è¡Œæ—¶é—´: $(date)"
        echo "  ä¸»æœºå: $(hostname)"
        echo "  ç”¨æˆ·: $(whoami)"
        echo ""
        
        # éªŒè¯å¿…è¦å‚æ•°
        if [ "$(params.repo-name)" = "unknown" ]; then
          echo "âŒ é”™è¯¯: ç¼ºå°‘ä»“åº“åç§°"
          exit 1
        fi
        
        if [ -z "$(params.repo-url)" ]; then
          echo "âŒ é”™è¯¯: ç¼ºå°‘ä»“åº“URL"
          exit 1
        fi
        
        echo "âœ… æ‰€æœ‰å‚æ•°éªŒè¯é€šè¿‡!"
        
    - name: simulate-ci-process
      image: cgr.dev/chainguard/bash:latest
      securityContext:
        allowPrivilegeEscalation: false
        runAsNonRoot: true
        capabilities:
          drop:
            - "ALL"
        seccompProfile:
          type: "RuntimeDefault"
      script: |
        #!/bin/bash
        set -e
        
        echo "ğŸ”¨ æ¨¡æ‹Ÿ CI/CD æµç¨‹..."
        echo "  æ­£åœ¨å¤„ç† $(params.provider) ä»“åº“: $(params.repo-name)"
        echo "  åˆ†æ”¯: $(params.branch)"
        echo "  æäº¤: $(params.commit-sha)"
        
        # æ¨¡æ‹Ÿä¸€äº› CI/CD æ“ä½œ
        echo "  â³ æ­¥éª¤ 1: ä»£ç æ£€å‡º"
        sleep 2
        echo "  âœ… ä»£ç æ£€å‡ºå®Œæˆ"
        
        echo "  â³ æ­¥éª¤ 2: ä¾èµ–å®‰è£…"
        sleep 1
        echo "  âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        
        echo "  â³ æ­¥éª¤ 3: è¿è¡Œæµ‹è¯•"
        sleep 2
        echo "  âœ… æµ‹è¯•é€šè¿‡"
        
        echo "  â³ æ­¥éª¤ 4: æ„å»ºåº”ç”¨"
        sleep 1
        echo "  âœ… æ„å»ºå®Œæˆ"
        
        echo "ğŸ‰ CI/CD æµç¨‹æˆåŠŸå®Œæˆ!"
        
    - name: record-result
      image: cgr.dev/chainguard/bash:latest
      securityContext:
        allowPrivilegeEscalation: false
        runAsNonRoot: true
        capabilities:
          drop:
            - "ALL"
        seccompProfile:
          type: "RuntimeDefault"
      script: |
        #!/bin/bash
        
        echo "ğŸ“ è®°å½•æµ‹è¯•ç»“æœ..."
        
        # åˆ›å»ºç»“æœè®°å½•
        cat << EOF > /tmp/test-result.json
        {
          "test_id": "$(params.reposentry-event-id)",
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "repository": {
            "name": "$(params.repo-name)",
            "url": "$(params.repo-url)",
            "branch": "$(params.branch)",
            "commit": "$(params.commit-sha)",
            "provider": "$(params.provider)"
          },
          "reposentry": {
            "event_id": "$(params.reposentry-event-id)",
            "timestamp": "$(params.reposentry-timestamp)"
          },
          "result": {
            "status": "success",
            "duration": "çº¦6ç§’",
            "steps_completed": 4
          }
        }
        EOF
        
        echo "âœ… æµ‹è¯•ç»“æœå·²è®°å½•:"
        cat /tmp/test-result.json
        
        echo ""
        echo "ğŸ¯ ç«¯åˆ°ç«¯æµ‹è¯•æ€»ç»“:"
        echo "  âœ… Webhook æ•°æ®æ¥æ”¶æˆåŠŸ"
        echo "  âœ… RepoSentry äº‹ä»¶å¤„ç†æˆåŠŸ"
        echo "  âœ… Tekton Pipeline è§¦å‘æˆåŠŸ"
        echo "  âœ… Task æ‰§è¡ŒæˆåŠŸ"
        echo ""
        echo "ğŸ‰ RepoSentry ç«¯åˆ°ç«¯æµ‹è¯•å®Œæˆ!"
